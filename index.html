<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Droppeteller – Mobil (auto-ROI + sporing)</title>
<style>
  html, body { margin:0; padding:0; background:#0b0b0f; color:#fff; font-family:sans-serif; }
  #app { padding:10px; max-width:900px; margin:auto; }
  button, select, input { padding:6px; border-radius:8px; border:1px solid #333; background:#111; color:#fff; }
  #video { display:none; }
  #canvas { width:100%; background:#000; border-radius:8px; }
</style>
</head>
<body>
<div id="app">
  <h2>Droppeteller – Mobil (auto-ROI + sporing)</h2>
  <div>
    <button id="btnStart">Start kamera</button>
    <select id="cameraSelect"></select>
    <label><input type="checkbox" id="showVideo"> Vis rå video (debug)</label>
  </div>
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div id="status"></div>
</div>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
let stream;

function setStatus(msg){ statusEl.textContent = msg; }

async function listCameras(){
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(d => d.kind === 'videoinput');
  const select = document.getElementById('cameraSelect');
  select.innerHTML = '';
  videoDevices.forEach((device, i) => {
    const opt = document.createElement('option');
    opt.value = device.deviceId;
    opt.text = device.label || `Kamera ${i+1}`;
    select.appendChild(opt);
  });
}

async function startCamera(){
  if(stream) stream.getTracks().forEach(t => t.stop());
  const deviceId = document.getElementById('cameraSelect').value;
  let constraints = { video: { deviceId: deviceId ? {exact: deviceId} : undefined } };
  try {
    stream = await navigator.mediaDevices.getUserMedia(constraints);
  } catch(e){
    setStatus('Første forsøk feilet, prøver fallback...');
    constraints = { video: true };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
  }
  video.srcObject = stream;
  await video.play();
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  requestAnimationFrame(drawLoop);
}

function drawLoop(){
  if(document.getElementById('showVideo').checked){
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  } else {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#333';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#fff';
    ctx.fillText('OpenCV-behandling kommer her', 20, 40);
  }
  requestAnimationFrame(drawLoop);
}

document.getElementById('btnStart').addEventListener('click', startCamera);

document.getElementById('showVideo').addEventListener('change', e => {
  video.style.display = e.target.checked ? 'block' : 'none';
});

navigator.mediaDevices.getUserMedia({video:true})
  .then(() => listCameras())
  .catch(err => setStatus('Krever kameratilgang: ' + err));
</script>
</body>
</html>
